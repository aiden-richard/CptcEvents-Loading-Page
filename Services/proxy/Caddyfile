{
	servers {
		# Trust X-Forwarded-* headers from Cloudflare Tunnel (private IP ranges)
		trusted_proxies static private_ranges
	}
}

:80 {
	reverse_proxy https://cptcevents-app.redforest-3d2b7eff.westus2.azurecontainerapps.io {
		# Preserve the original Host header for Azure Container Apps TLS
		header_up Host {upstream_hostport}

		# Set a 2 second timeout before Caddy throws a 504 Gateway Timeout
		transport http {
			tls
			dial_timeout 2s
			response_header_timeout 2s
		}
	}

	# Catch 504 timeout errors and serve loading page (only for HTML/navigation requests)
	handle_errors 504 {
		@html {
			header Accept *text/html*
		}
		handle @html {
			header Content-Type text/html
			header X-Coldstart "1"
			header Cache-Control "no-store"
			root * /var/www/coldstart
			rewrite * /loading.html
			file_server {
				status 200
			}
		}
		# Let non-HTML requests (CSS, JS, images) fail with original 504
		handle {
			respond "Gateway Timeout" 504
		}
	}
}
